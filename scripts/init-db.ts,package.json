// scripts/init-db.ts
import fs from 'fs/promises'

type Result =
  | { ok: true }
  | { ok: false; status?: number; message: string }

function extractOrigin(raw: string): string {
  try {
    const u = new URL(raw)
    return `${u.protocol}//${u.host}`
  } catch {
    const u2 = new URL(`https://${raw}`)
    return `${u2.protocol}//${u2.host}`
  }
}

function diagnoseUrlProblem(supabaseUrl: string): string | null {
  const hasRestPath = /\/rest\/v1\b/.test(supabaseUrl)
  const hasAnyPath = /^https?:\/\/[^/]+\/.+/.test(supabaseUrl)
  if (hasRestPath) return 'SUPABASE_URL に /rest/v1 を含めないでください。https://{ref}.supabase.co のみを設定してください。'
  if (hasAnyPath) return 'SUPABASE_URL はドメイン（オリジン）のみを設定してください。パスは含めないでください。'
  return null
}

async function run(): Promise<void> {
  const SUPABASE_URL =
    process.env.SUPABASE_URL ||
    process.env.NEXT_PUBLIC_SUPABASE_URL ||
    ''

  const SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE_KEY || ''

  if (!SUPABASE_URL || !SERVICE_ROLE) {
    console.error('❌ 環境変数が未設定です。SUPABASE_URL と SUPABASE_SERVICE_ROLE_KEY を設定してください。')
    process.exit(1)
  }

  const hint = diagnoseUrlProblem(SUPABASE_URL)
  if (hint) {
    console.error(`❌ requested path is invalid: ${hint}`)
    console.error('例: SUPABASE_URL=https://yqnluaxuhbgtndmdmciv.supabase.co')
    process.exit(1)
  }

  const origin = extractOrigin(SUPABASE_URL)
  const endpoint = `${origin}/postgres/v1/query`

  const sqlPath = new URL('./setup-database.sql', import.meta.url)
  const sql = await fs.readFile(sqlPath, 'utf8')

  console.log('➡️  Posting SQL to:', endpoint)
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${SERVICE_ROLE}`,
      apikey: SERVICE_ROLE,
      'Content-Type': 'application/json',
      Accept: 'application/json',
      Prefer: 'tx=commit',
    },
    body: JSON.stringify({ query: sql }),
  })

  const text = await res.text().catch(() => '')

  if (!res.ok) {
    const msg = text || `HTTP ${res.status}`
    console.error('❌ 初期化に失敗しました')
    console.error('Status:', res.status)
    console.error('Body  :', msg)
    if (/requested path is invalid/i.test(msg)) {
      console.error('\nヒント: SUPABASE_URL に /rest/v1 などのパスが含まれている可能性があります。')
      console.error('https://{ref}.supabase.co のみを設定してください（末尾スラッシュ不要）。')
    }
    process.exit(1)
  }

  console.log('✅ 初期化に成功しました。必要なら 5〜10 秒後にアプリを再読込してください。')
}

run().catch((e) => {
  console.error('❌ 予期せぬエラー:', e?.message || e)
  process.exit(1)
})

// package.json
{
  "packageManager": "npm@10.8.2",
  "engines": {
    "node": ">=18.18 <23"
  }
}
